/**
    * @license
    * Copyright 2023 Google LLC. All Rights Reserved.
    * Licensed under the Apache License, Version 2.0 (the "License");
    * you may not use this file except in compliance with the License.
    * You may obtain a copy of the License at
    *
    * http://www.apache.org/licenses/LICENSE-2.0
    *
    * Unless required by applicable law or agreed to in writing, software
    * distributed under the License is distributed on an "AS IS" BASIS,
    * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    * See the License for the specific language governing permissions and
    * limitations under the License.
    * =============================================================================
    */
!function(t,n){"object"==typeof exports&&"undefined"!=typeof module?n(exports,require("@tensorflow/tfjs-converter"),require("@tensorflow/tfjs-core")):"function"==typeof define&&define.amd?define(["exports","@tensorflow/tfjs-converter","@tensorflow/tfjs-core"],n):n((t=t||self).handpose={},t.tf,t.tf)}(this,(function(t,n,e){"use strict";function r(t,n,e,r){return new(e||(e=Promise))((function(o,i){function s(t){try{u(r.next(t))}catch(t){i(t)}}function a(t){try{u(r.throw(t))}catch(t){i(t)}}function u(t){var n;t.done?o(t.value):(n=t.value,n instanceof e?n:new e((function(t){t(n)}))).then(s,a)}u((r=r.apply(t,n||[])).next())}))}function o(t,n){var e,r,o,i,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(a){return function(u){return function(a){if(e)throw new TypeError("Generator is already executing.");for(;i&&(i=0,a[0]&&(s=0)),s;)try{if(e=1,r&&(o=2&a[0]?r.return:a[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,a[1])).done)return o;switch(r=0,o&&(a=[2&a[0],o.value]),a[0]){case 0:case 1:o=a;break;case 4:return s.label++,{value:a[1],done:!1};case 5:s.label++,r=a[1],a=[0];continue;case 7:a=s.ops.pop(),s.trys.pop();continue;default:if(!(o=s.trys,(o=o.length>0&&o[o.length-1])||6!==a[0]&&2!==a[0])){s=0;continue}if(3===a[0]&&(!o||a[1]>o[0]&&a[1]<o[3])){s.label=a[1];break}if(6===a[0]&&s.label<o[1]){s.label=o[1],o=a;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(a);break}o[2]&&s.ops.pop(),s.trys.pop();continue}a=n.call(t,s)}catch(t){a=[6,t],r=0}finally{e=o=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,u])}}}function i(t,n,e){if(e||2===arguments.length)for(var r,o=0,i=n.length;o<i;o++)!r&&o in n||(r||(r=Array.prototype.slice.call(n,0,o)),r[o]=n[o]);return t.concat(r||Array.prototype.slice.call(n))}"function"==typeof SuppressedError&&SuppressedError;function s(t){return[Math.abs(t.endPoint[0]-t.startPoint[0]),Math.abs(t.endPoint[1]-t.startPoint[1])]}function a(t){return[t.startPoint[0]+(t.endPoint[0]-t.startPoint[0])/2,t.startPoint[1]+(t.endPoint[1]-t.startPoint[1])/2]}function u(t,n){void 0===n&&(n=1.5);var e=a(t),r=s(t),o=[n*r[0]/2,n*r[1]/2];return{startPoint:[e[0]-o[0],e[1]-o[1]],endPoint:[e[0]+o[0],e[1]+o[1]],palmLandmarks:t.palmLandmarks}}function d(t){var n=a(t),e=s(t),r=Math.max.apply(Math,e)/2;return{startPoint:[n[0]-r,n[1]-r],endPoint:[n[0]+r,n[1]+r],palmLandmarks:t.palmLandmarks}}function h(t,n){var e=[t.endPoint[0]-t.startPoint[0],t.endPoint[1]-t.startPoint[1]],r=[e[0]*n[0],e[1]*n[1]];return{startPoint:[t.startPoint[0]+r[0],t.startPoint[1]+r[1]],endPoint:[t.endPoint[0]+r[0],t.endPoint[1]+r[1]],palmLandmarks:t.palmLandmarks}}var c=function(){function t(t,n,r,o,i,s){this.model=t,this.width=n,this.height=r,this.iouThreshold=i,this.scoreThreshold=s,this.anchors=o.map((function(t){return[t.x_center,t.y_center]})),this.anchorsTensor=e.tensor2d(this.anchors),this.inputSizeTensor=e.tensor1d([n,r]),this.doubleInputSizeTensor=e.tensor1d([2*n,2*r])}return t.prototype.normalizeBoxes=function(t){var n=this;return e.tidy((function(){var r=e.slice(t,[0,0],[-1,2]),o=e.slice(t,[0,2],[-1,2]),i=e.add(e.div(r,n.inputSizeTensor),n.anchorsTensor),s=e.div(o,n.doubleInputSizeTensor),a=e.mul(e.sub(i,s),n.inputSizeTensor),u=e.mul(e.add(i,s),n.inputSizeTensor);return e.concat2d([a,u],1)}))},t.prototype.normalizeLandmarks=function(t,n){var r=this;return e.tidy((function(){var o=e.add(e.div(e.reshape(t,[-1,7,2]),r.inputSizeTensor),r.anchors[n]);return e.mul(o,r.inputSizeTensor)}))},t.prototype.getBoundingBoxes=function(t){return r(this,void 0,void 0,(function(){var n,r,i,s,a,u,d,h,c,f,l,p,m,v,g,P=this;return o(this,(function(o){switch(o.label){case 0:return n=e.tidy((function(){return e.mul(e.sub(t,.5),2)})),"webgl"===e.getBackend()?(i=e.env().get("WEBGL_PACK_DEPTHWISECONV"),e.env().set("WEBGL_PACK_DEPTHWISECONV",!0),r=this.model.predict(n),e.env().set("WEBGL_PACK_DEPTHWISECONV",i)):r=this.model.predict(n),s=e.squeeze(r),a=e.tidy((function(){return e.squeeze(e.sigmoid(e.slice(s,[0,0],[-1,1])))})),u=e.slice(s,[0,1],[-1,4]),d=this.normalizeBoxes(u),h=console.warn,console.warn=function(){},c=e.image.nonMaxSuppression(d,a,1,this.iouThreshold,this.scoreThreshold),console.warn=h,[4,c.array()];case 1:return f=o.sent(),l=[n,r,c,s,d,u,a],0===f.length?(l.forEach((function(t){return t.dispose()})),[2,null]):(p=f[0],m=e.slice(d,[p,0],[1,-1]),v=e.slice(s,[p,5],[1,14]),g=e.tidy((function(){return e.reshape(P.normalizeLandmarks(v,p),[-1,2])})),l.push(v),l.forEach((function(t){return t.dispose()})),[2,{boxes:m,palmLandmarks:g}])}}))}))},t.prototype.estimateHandBounds=function(t){return r(this,void 0,void 0,(function(){var n,r,i,s,a,u,d,h,c=this;return o(this,(function(o){switch(o.label){case 0:return n=t.shape[1],r=t.shape[2],i=e.tidy((function(){return e.div(e.image.resizeBilinear(t,[c.width,c.height]),255)})),[4,this.getBoundingBoxes(i)];case 1:return null===(s=o.sent())?(i.dispose(),[2,null]):(a=s.boxes.arraySync(),u=a[0].slice(0,2),d=a[0].slice(2,4),h=s.palmLandmarks.arraySync(),i.dispose(),s.boxes.dispose(),s.palmLandmarks.dispose(),[2,(f={startPoint:u,endPoint:d,palmLandmarks:h},l=[r/this.width,n/this.height],{startPoint:[f.startPoint[0]*l[0],f.startPoint[1]*l[1]],endPoint:[f.endPoint[0]*l[0],f.endPoint[1]*l[1]],palmLandmarks:f.palmLandmarks.map((function(t){return[t[0]*l[0],t[1]*l[1]]}))})])}var f,l}))}))},t}(),f={thumb:[1,2,3,4],indexFinger:[5,6,7,8],middleFinger:[9,10,11,12],ringFinger:[13,14,15,16],pinky:[17,18,19,20],palmBase:[0]};function l(t,n){var e,r=Math.PI/2-Math.atan2(-(n[1]-t[1]),n[0]-t[0]);return(e=r)-2*Math.PI*Math.floor((e+Math.PI)/(2*Math.PI))}var p=function(t,n){return[[1,0,t],[0,1,n],[0,0,1]]};function m(t,n){for(var e=0,r=0;r<t.length;r++)e+=t[r]*n[r];return e}function v(t,n){for(var e=[],r=0;r<t.length;r++)e.push(t[r][n]);return e}function g(t,n){for(var e=[],r=t.length,o=0;o<r;o++){e.push([]);for(var i=0;i<r;i++)e[o].push(m(t[o],v(n,i)))}return e}function P(t,n){var e=Math.cos(t),r=Math.sin(t),o=[[e,-r,0],[r,e,0],[0,0,1]],i=g(p(n[0],n[1]),o);return g(i,p(-n[0],-n[1]))}function y(t,n){return[m(t,n[0]),m(t,n[1])]}var b=[0,-.4],k=[0,-.1],x=[0,5,9,13,17,1,2],w=function(){function t(t,n,e,r,o,i){this.boundingBoxDetector=t,this.meshDetector=n,this.meshWidth=e,this.meshHeight=r,this.maxContinuousChecks=o,this.detectionConfidence=i,this.regionsOfInterest=[],this.runsWithoutHandDetector=0,this.maxHandsNumber=1}return t.prototype.getBoxForPalmLandmarks=function(t,n){var e=t.map((function(t){return y(i(i([],t,!0),[1],!1),n)}));return u(d(h(this.calculateLandmarksBoundingBox(e),b)),3)},t.prototype.getBoxForHandLandmarks=function(t){for(var n=u(d(h(this.calculateLandmarksBoundingBox(t),k)),1.65),e=[],r=0;r<x.length;r++)e.push(t[x[r]].slice(0,2));return n.palmLandmarks=e,n},t.prototype.transformRawCoords=function(t,n,e,r){var o,u,d,h,c=this,f=s(n),l=[f[0]/this.meshWidth,f[1]/this.meshHeight],p=t.map((function(t){return[l[0]*(t[0]-c.meshWidth/2),l[1]*(t[1]-c.meshHeight/2),t[2]]})),v=P(e,[0,0]),g=p.map((function(t){return i(i([],y(t,v),!0),[t[2]],!1)})),b=(u=[[(o=r)[0][0],o[1][0]],[o[0][1],o[1][1]]],d=[o[0][2],o[1][2]],h=[-m(u[0],d),-m(u[1],d)],[u[0].concat(h[0]),u[1].concat(h[1]),[0,0,1]]),k=i(i([],a(n),!0),[1],!1),x=[m(k,b[0]),m(k,b[1])];return g.map((function(t){return[t[0]+x[0],t[1]+x[1],t[2]]}))},t.prototype.estimateHand=function(t){return r(this,void 0,void 0,(function(){var n,r,i,s,u,d,h,c,f,p,m,v,g,y,b,k,x,w,B,L;return o(this,(function(o){switch(o.label){case 0:return!0!==(n=this.shouldUpdateRegionsOfInterest())?[3,2]:[4,this.boundingBoxDetector.estimateHandBounds(t)];case 1:return null===(r=o.sent())?(t.dispose(),this.regionsOfInterest=[],[2,null]):(this.updateRegionsOfInterest(r,!0),this.runsWithoutHandDetector=0,[3,3]);case 2:this.runsWithoutHandDetector++,o.label=3;case 3:return i=this.regionsOfInterest[0],s=l(i.palmLandmarks[0],i.palmLandmarks[2]),u=a(i),d=[u[0]/t.shape[2],u[1]/t.shape[1]],h=e.image.rotateWithOffset(t,s,0,d),c=P(-s,u),f=!0===n?this.getBoxForPalmLandmarks(i.palmLandmarks,c):i,p=function(t,n,r){var o=n.shape[1],i=n.shape[2],s=[[t.startPoint[1]/o,t.startPoint[0]/i,t.endPoint[1]/o,t.endPoint[0]/i]];return e.image.cropAndResize(n,s,[0],r)}(f,h,[this.meshWidth,this.meshHeight]),m=e.div(p,255),p.dispose(),h.dispose(),"webgl"===e.getBackend()?(g=e.env().get("WEBGL_PACK_DEPTHWISECONV"),e.env().set("WEBGL_PACK_DEPTHWISECONV",!0),v=this.meshDetector.predict(m),e.env().set("WEBGL_PACK_DEPTHWISECONV",g)):v=this.meshDetector.predict(m),y=v[0],b=v[1],m.dispose(),k=y.dataSync()[0],y.dispose(),k<this.detectionConfidence?(b.dispose(),this.regionsOfInterest=[],[2,null]):(x=e.reshape(b,[-1,3]),w=x.arraySync(),b.dispose(),x.dispose(),B=this.transformRawCoords(w,f,s,c),L=this.getBoxForHandLandmarks(B),this.updateRegionsOfInterest(L,!1),[2,{landmarks:B,handInViewConfidence:k,boundingBox:{topLeft:L.startPoint,bottomRight:L.endPoint}}])}}))}))},t.prototype.calculateLandmarksBoundingBox=function(t){var n=t.map((function(t){return t[0]})),e=t.map((function(t){return t[1]}));return{startPoint:[Math.min.apply(Math,n),Math.min.apply(Math,e)],endPoint:[Math.max.apply(Math,n),Math.max.apply(Math,e)]}},t.prototype.updateRegionsOfInterest=function(t,n){if(n)this.regionsOfInterest=[t];else{var e=this.regionsOfInterest[0],r=0;if(null!=e&&null!=e.startPoint){var o=t.startPoint,i=o[0],s=o[1],a=t.endPoint,u=a[0],d=a[1],h=e.startPoint,c=h[0],f=h[1],l=e.endPoint,p=l[0],m=l[1],v=Math.max(i,c),g=Math.max(s,f),P=(Math.min(u,p)-v)*(Math.min(d,m)-g);r=P/((u-i)*(d-s)+(p-c)*(m-s)-P)}this.regionsOfInterest[0]=r>.8?e:t}},t.prototype.shouldUpdateRegionsOfInterest=function(){return this.regionsOfInterest.length!==this.maxHandsNumber||this.runsWithoutHandDetector>=this.maxContinuousChecks},t}();function B(){return r(this,void 0,void 0,(function(){return o(this,(function(t){return"https://tfhub.dev/mediapipe/tfjs-model/handdetector/1/default/1",[2,n.loadGraphModel("https://tfhub.dev/mediapipe/tfjs-model/handdetector/1/default/1",{fromTFHub:!0})]}))}))}function L(){return r(this,void 0,void 0,(function(){return o(this,(function(t){return"https://tfhub.dev/mediapipe/tfjs-model/handskeleton/1/default/1",[2,n.loadGraphModel("https://tfhub.dev/mediapipe/tfjs-model/handskeleton/1/default/1",{fromTFHub:!0})]}))}))}function I(){return r(this,void 0,void 0,(function(){return o(this,(function(t){return[2,e.util.fetch("https://tfhub.dev/mediapipe/tfjs-model/handskeleton/1/default/1/anchors.json?tfjs-format=file").then((function(t){return t.json()}))]}))}))}var C=function(){function t(t){this.pipeline=t}return t.getAnnotations=function(){return f},t.prototype.estimateHands=function(t,n){return void 0===n&&(n=!1),r(this,void 0,void 0,(function(){var r,i,s,a,u,d,h,c,l;return o(this,(function(o){switch(o.label){case 0:return r=function(t){return t instanceof e.Tensor?[t.shape[0],t.shape[1]]:[t.height,t.width]}(t),i=r[1],s=e.tidy((function(){return t instanceof e.Tensor||(t=e.browser.fromPixels(t)),e.expandDims(e.cast(t,"float32"))})),[4,this.pipeline.estimateHand(s)];case 1:if(a=o.sent(),s.dispose(),null===a)return[2,[]];for(u=a,!0===n&&(u=function(t,n){var e=t.handInViewConfidence,r=t.landmarks,o=t.boundingBox;return{handInViewConfidence:e,landmarks:r.map((function(t){return[n-1-t[0],t[1],t[2]]})),boundingBox:{topLeft:[n-1-o.topLeft[0],o.topLeft[1]],bottomRight:[n-1-o.bottomRight[0],o.bottomRight[1]]}}}(a,i)),d={},h=0,c=Object.keys(f);h<c.length;h++)l=c[h],d[l]=f[l].map((function(t){return u.landmarks[t]}));return[2,[{handInViewConfidence:u.handInViewConfidence,boundingBox:u.boundingBox,landmarks:u.landmarks,annotations:d}]]}}))}))},t}();t.HandPose=C,t.load=function(t){var n=void 0===t?{}:t,e=n.maxContinuousChecks,i=void 0===e?1/0:e,s=n.detectionConfidence,a=void 0===s?.8:s,u=n.iouThreshold,d=void 0===u?.3:u,h=n.scoreThreshold,f=void 0===h?.5:h;return r(this,void 0,void 0,(function(){var t,n,e,r,s,u;return o(this,(function(o){switch(o.label){case 0:return[4,Promise.all([I(),B(),L()])];case 1:return t=o.sent(),n=t[0],e=t[1],r=t[2],s=new c(e,256,256,n,d,f),u=new w(s,r,256,256,i,a),[2,new C(u)]}}))}))},Object.defineProperty(t,"__esModule",{value:!0})}));
